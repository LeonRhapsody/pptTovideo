<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPT to Video Studio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --nav-bg: #1a1b26;
            --sidebar-left-bg: #f8f9fa;
            --workspace-bg: #e5e7eb;
            --sidebar-right-bg: #ffffff;
            --accent-blue: #0052cc;
            --tab-active-bg: #ffffff;
            --tab-inactive-bg: #f3f4f6;
            --text-main: #1f2937;
            --text-dim: #6b7280;
            --border-light: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--workspace-bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Navigation */
        .top-nav {
            height: 56px;
            background-color: var(--nav-bg);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            color: white;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-left,
        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-logo {
            font-size: 18px;
            font-weight: 700;
            color: #4db3ff;
            letter-spacing: 0.5px;
        }

        .nav-title {
            font-size: 13px;
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 12px;
            border-radius: 4px;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex-direction: row;
            flex: 1;
            height: calc(100vh - 56px);
            overflow: hidden;
        }

        /* Left Sidebar */
        .sidebar-left {
            width: 140px;
            background-color: var(--sidebar-left-bg);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .btn-import {
            width: 100%;
            padding: 10px;
            background: white;
            border: 1px solid var(--accent-blue);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .btn-import:hover {
            background: #f0f7ff;
        }

        .slide-item {
            width: 100%;
            margin-bottom: 12px;
            cursor: pointer;
            border-radius: 6px;
            border: 2px solid transparent;
            overflow: hidden;
            transition: all 0.2s;
            position: relative;
        }

        .slide-item.active {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow);
        }

        .slide-thumb {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: #000;
            display: block;
        }

        .slide-num {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Center Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--workspace-bg);
            overflow-y: auto;
            position: relative;
        }

        .toolbar {
            height: 48px;
            background: #ffffff;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 32px;
            font-size: 13px;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .editor-container {
            flex: 1;
            padding: 24px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .preview-box {
            width: 100%;
            max-width: 1000px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        #current-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .script-box {
            width: 100%;
            max-width: 1000px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .script-toolbar {
            background: #f9fafb;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 20px;
        }

        .script-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .script-btn:hover {
            color: var(--accent-blue);
            background: #f3f4f6;
        }

        .script-textarea {
            width: 100%;
            height: 160px;
            padding: 20px;
            border: none;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            outline: none;
            box-sizing: border-box;
        }

        /* Right Sidebar Panel */
        .sidebar-right {
            width: 280px;
            height: 100%;
            background: var(--sidebar-right-bg);
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-shrink: 0;
        }

        .side-tabs {
            width: 56px;
            background: var(--tab-inactive-bg);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 16px;
        }

        .tab-icon {
            width: 100%;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 16px;
            gap: 4px;
        }

        .tab-icon span {
            font-size: 10px;
        }

        .tab-icon.active {
            background: #ffffff;
            color: var(--accent-blue);
            margin-right: -1px;
            border-right: 2px solid var(--accent-blue);
        }

        .tab-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Generic Components */
        .btn-modern {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-blue {
            background: var(--accent-blue);
            color: white;
        }

        .btn-blue:hover {
            background: #0045ad;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
        }

        /* Modals & Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-panel {
            background: white;
            padding: 40px;
            border-radius: 16px;
            width: 480px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Empty State */
        .full-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--workspace-bg);
            z-index: 50;
        }

        .upload-card {
            background: white;
            padding: 64px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 2px dashed #ddd;
            text-align: center;
            cursor: pointer;
        }

        .upload-card:hover {
            border-color: var(--accent-blue);
            transform: scale(1.02);
            transition: 0.3s;
        }

        /* Spinner */
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background: #4caf50;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Sliders */
        .range-container {
            margin-bottom: 20px;
        }

        .range-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .range-slider {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <!-- Loading Overlay -->
    <div id="loader" class="overlay">
        <div class="modal-panel">
            <div class="spinner"></div>
            <h3 id="loader-text">正在处理...</h3>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="result-modal" class="overlay">
        <div class="modal-panel">
            <i class="fas fa-check-circle" style="font-size: 48px; color: #4caf50; margin-bottom: 20px;"></i>
            <h2>视频已生成!</h2>
            <p>您的视频已准备就绪，可以下载。</p>
            <a id="download-link" href="#" class="btn-modern btn-blue"
                style="display: block; text-decoration: none; margin-top: 24px;">立即下载 MP4</a>
            <button onclick="document.getElementById('result-modal').style.display='none'" class="btn-modern"
                style="margin-top: 12px; width: 100%; background: #eee;">关闭</button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="overlay">
        <div class="modal-panel" style="border-top: 4px solid #f44336;">
            <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #f44336; margin-bottom: 20px;"></i>
            <h2>发生错误</h2>
            <p id="error-text" style="color: #666; font-size: 14px; margin: 10px 0;"></p>
            <button onclick="hideError()" class="btn-modern btn-blue" style="width: 100%; margin-top: 20px;">确定</button>
        </div>
    </div>

    <!-- Task Manager Modal (Deprecated in 2.0, hidden for compatibility) -->
    <div id="task-modal" class="overlay" style="display:none;">
        <div id="task-list"></div>
    </div>

    <nav class="top-nav">
        <div class="nav-left">
            <div class="nav-logo">
                <i class="fas fa-wand-magic-sparkles"></i> 亚信智作 | PPT
            </div>
            <div class="nav-title">
                <i class="fas fa-chevron-left" style="font-size: 12px; cursor: pointer;"></i>
                <span id="project-name-display">未命名项目</span>
                <i class="fas fa pen" style="font-size: 10px; cursor: pointer;"></i>
            </div>
        </div>
        <div class="nav-right">
            <button class="btn-modern btn-outline" onclick="toggleTaskManager()">
                <i class="fas fa-tasks"></i> 任务管理
            </button>
            <button class="btn-modern btn-blue" onclick="generateVideo()">
                生成视频
            </button>
        </div>
    </nav>

    <div class="main-layout">
        <!-- Sidebar Left: Slide Navigation -->
        <aside class="sidebar-left">
            <button class="btn-import" onclick="triggerUpload()">
                <i class="fas fa-plus-circle"></i> 导入 PPT
            </button>
            <div id="slide-list" class="slide-list">
                <!-- Slides injected here -->
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="workspace">
            <!-- Empty State -->
            <div id="empty-state" class="full-overlay">
                <div class="upload-card" onclick="triggerUpload()">
                    <i class="fas fa-cloud-arrow-up" style="font-size: 48px; color: #0052cc; margin-bottom: 20px;"></i>
                    <h2>开始创作</h2>
                    <p style="color: #666;">点击此处上传您的 PowerPoint (.pptx) 文件</p>
                </div>
            </div>

            <div id="workspace-ui" style="display: none; height: 100%; display: flex; flex-direction: column;">
                <div class="toolbar">
                    <div class="toolbar-item">项目状态: <b id="project-status">就绪</b></div>
                    <div class="toolbar-item" id="slide-info">当前幻灯片: 1/1</div>
                </div>

                <div class="editor-container">
                    <div class="preview-box">
                        <img id="current-image" src="" alt="Slide Preview">
                    </div>

                    <div class="script-box">
                        <div class="script-toolbar">
                            <button class="script-btn" onclick="playPreview()">
                                <i class="fas fa-headphones"></i>
                                <span>试听</span>
                            </button>
                            <button class="script-btn" onclick="insertPause()">
                                <i class="fas fa-bolt"></i>
                                <span>停顿</span>
                            </button>
                        </div>
                        <textarea id="script-text" class="script-textarea" placeholder="在此输入当前页面的文案内容..."></textarea>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar Right: Tools & Tabs -->
        <aside class="sidebar-right">
            <div class="side-tabs">
                <div class="tab-icon active" onclick="switchTab('voice', this)">
                    <i class="fas fa-microphone"></i>
                    <span>声音</span>
                </div>
                <div class="tab-icon" onclick="switchTab('subtitle', this)">
                    <i class="fas fa-closed-captioning"></i>
                    <span>字幕</span>
                </div>
                <div class="tab-icon" onclick="switchTab('export', this)">
                    <i class="fas fa-file-export"></i>
                    <span>导出</span>
                </div>
                <div class="tab-icon" onclick="switchTab('tasks', this)">
                    <i class="fas fa-list-check"></i>
                    <span>任务</span>
                </div>
                <div class="tab-icon" onclick="switchTab('api', this)">
                    <i class="fas fa-sliders-h"></i>
                    <span>设置</span>
                </div>
            </div>
            <div class="tab-content" id="panel-container">
                <!-- Voice Panel -->
                <div id="tab-voice" class="tab-panel active">
                    <h3 style="font-size: 14px; margin-bottom: 16px;">选择配音师</h3>
                    <div class="form-group">
                        <label class="form-label">供应商</label>
                        <select id="engine-select" class="form-select">
                            <option value="edge">Microsoft Edge (推荐)</option>
                            <option value="system">macOS 本地 (离线/免费)</option>
                            <option value="xunfei">iFLYTEK (讯飞智作)</option>
                            <option value="volcengine">火山引擎 (Volcengine)</option>
                            <option value="google">Google Cloud TTS</option>
                            <option value="openai">OpenAI TTS</option>
                            <option value="fishspeech">Fish Speech (新)</option>

                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">人声设定</label>
                        <select id="voice-select" class="form-select">
                            <optgroup label="macOS 本地 (限 System 引擎)">
                                <option value="Tingting">婷婷 (普通话)</option>
                                <option value="Meijia">美佳 (台湾)</option>
                                <option value="Sinji">善怡 (粤语)</option>
                            </optgroup>
                            <optgroup label="普通话 (大陆)">
                                <option value="zh-CN-XiaoxiaoNeural">晓晓 (女声, 温暖)</option>
                                <option value="zh-CN-YunxiNeural">云希 (男声, 沉稳)</option>
                                <option value="zh-CN-YunjianNeural">云健 (男声, 活力)</option>
                                <option value="zh-CN-YunyangNeural">云扬 (男声, 播音)</option>
                            </optgroup>
                            <optgroup label="粤语 (香港)">
                                <option value="zh-HK-HiuGaaiNeural">晓佳 (女声)</option>
                                <option value="zh-HK-WanLungNeural">云龙 (男声)</option>
                            </optgroup>
                            <optgroup label="英语 (美国)">
                                <option value="en-US-AriaNeural">Aria (Female)</option>
                                <option value="en-US-GuyNeural">Guy (Male)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="range-container">
                        <div class="range-header">
                            <label class="form-label">语速</label>
                            <span id="rate-val" style="font-size: 11px; color: var(--accent-blue);">1.0x</span>
                        </div>
                        <input type="range" id="rate-slider" class="range-slider" min="0.5" max="2.0" step="0.1"
                            value="1.0">
                    </div>

                    <div class="range-container">
                        <div class="range-header">
                            <label class="form-label">音量</label>
                            <span id="volume-val" style="font-size: 11px; color: var(--accent-blue);">100%</span>
                        </div>
                        <input type="range" id="volume-slider" class="range-slider" min="0" max="150" step="5"
                            value="100">
                    </div>

                    <div class="range-container">
                        <div class="range-header">
                            <label class="form-label">音高</label>
                            <span id="pitch-val" style="font-size: 11px; color: var(--accent-blue);">0Hz</span>
                        </div>
                        <input type="range" id="pitch-slider" class="range-slider" min="-20" max="20" step="1"
                            value="0">
                    </div>
                </div>

                <!-- Subtitle Panel -->
                <div id="tab-subtitle" class="tab-panel">
                    <h3 style="font-size: 14px; margin-bottom: 16px;">字幕设置</h3>
                    <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                        <label class="form-label" style="margin-bottom: 0;">显示字幕</label>
                        <label class="switch">
                            <input type="checkbox" id="subtitle-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">字体大小</label>
                        <input type="number" id="subtitle-size" class="form-select" value="48" min="20" max="100">
                    </div>
                </div>

                <!-- Export Panel -->
                <div id="tab-export" class="tab-panel">
                    <h3 style="font-size: 14px; margin-bottom: 16px;">渲染与导出</h3>
                    <div class="form-group">
                        <label class="form-label">视频清晰度</label>
                        <select id="quality-select" class="form-select">
                            <option value="720p">720P (标清)</option>
                            <option value="1080p" selected>1080P (高清)</option>
                            <option value="4k">4K (超清)</option>
                        </select>
                        <p style="font-size: 11px; color: var(--text-dim); margin-top: 8px;">
                            4K 模式将以 300 DPI 渲染幻灯片，耗时较长。
                        </p>
                    </div>
                </div>

                <!-- Task Panel -->
                <div id="tab-tasks" class="tab-panel">
                    <h3 style="font-size: 14px; margin-bottom: 16px;">任务队列</h3>
                    <div id="task-list-v2" style="font-size: 12px;">
                        <!-- Tasks will be rendered here -->
                    </div>
                </div>

                <!-- API Settings Panel -->
                <div id="tab-api" class="tab-panel">
                    <h3 style="font-size: 14px; margin-bottom: 16px;">系统配置</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div
                            style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
                            <label class="form-label" style="color: var(--accent-blue);">OpenAI / LLM</label>
                            <input type="password" id="openai-key" class="form-select" placeholder="API Key"
                                style="margin-bottom: 8px;">
                            <input type="text" id="openai-base-url" class="form-select" placeholder="Base URL (可选)">
                        </div>

                        <div
                            style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
                            <label class="form-label" style="color: var(--accent-blue);">火山引擎 (Volcengine)</label>
                            <input type="text" id="volc-access-key" class="form-select" placeholder="Access Key"
                                style="margin-bottom: 8px;">
                            <input type="password" id="volc-secret-key" class="form-select" placeholder="Secret Key"
                                style="margin-bottom: 8px;">
                            <input type="text" id="volc-app-key" class="form-select" placeholder="App Key">
                        </div>

                        <div
                            style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
                            <label class="form-label" style="color: var(--accent-blue);">讯飞智作 (iFLYTEK)</label>
                            <input type="text" id="xunfei-appid" class="form-select" placeholder="AppID"
                                style="margin-bottom: 8px;">
                            <input type="text" id="xunfei-api-key" class="form-select" placeholder="API Key"
                                style="margin-bottom: 8px;">
                            <input type="password" id="xunfei-api-secret" class="form-select" placeholder="API Secret">
                        </div>

                        <div
                            style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
                            <label class="form-label" style="color: var(--accent-blue);">Fish Speech</label>
                            <input type="password" id="fish-key" class="form-select" placeholder="API Key"
                                style="margin-bottom: 8px;">
                            <input type="text" id="fish-url" class="form-select"
                                placeholder="API URL (默认: https://api.fish.audio/v1/tts)">
                        </div>

                        <div
                            style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
                            <label class="form-label" style="color: var(--accent-blue);">Google Cloud</label>
                            <input type="password" id="google-key" class="form-select" placeholder="API Key">
                        </div>
                    </div>

                    <button class="btn-modern btn-blue" onclick="saveConfig()"
                        style="width: 100%; margin-top: 20px;">保存配置</button>
                    <div id="save-msg"
                        style="margin-top: 10px; color: #4caf50; font-size: 12px; display: none; text-align: center;">
                        <i class="fas fa-check"></i> 配置已永久保存
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <audio id="audio-player" hidden></audio>
    <input type="file" id="file-upload" hidden accept=".pptx">

    <audio id="audio-player" hidden></audio>

    <script>
        // State
        let currentJobId = null;
        let slides = [];
        let currentIndex = -1;

        // Elements
        const fileInput = document.getElementById('file-upload');
        const emptyState = document.getElementById('empty-state');
        const workspaceUI = document.getElementById('workspace-ui');
        const slideList = document.getElementById('slide-list');
        const currentImage = document.getElementById('current-image');
        const scriptText = document.getElementById('script-text');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');

        // Tab Switching Logic
        function switchTab(tabId, el) {
            // Update Icon state
            document.querySelectorAll('.tab-icon').forEach(icon => icon.classList.remove('active'));
            el.classList.add('active');

            // Update Panel state
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            if (tabId === 'tasks') pollTasks();
        }

        function triggerUpload() {
            fileInput.click();
        }

        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            const file = e.target.files[0];

            showLoader("正在解析 PPT...");
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/parse', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                currentJobId = data.job_id;
                slides = data.slides;

                // Update Project Name
                document.getElementById('project-name-display').innerText = file.name.replace('.pptx', '');

                initWorkspace();
            } catch (err) {
                showError("导入失败: " + err.message);
            } finally {
                hideLoader();
            }
        });

        function initWorkspace() {
            emptyState.style.display = 'none';
            workspaceUI.style.display = 'flex';
            renderSlideList();
            selectSlide(0);
        }

        function renderSlideList() {
            slideList.innerHTML = '';
            slides.forEach((slide, idx) => {
                const div = document.createElement('div');
                div.className = `slide-item ${idx === currentIndex ? 'active' : ''}`;
                div.onclick = () => selectSlide(idx);
                div.innerHTML = `
                    <div style="position: relative;">
                        <img src="${slide.image_url}" class="slide-thumb">
                        <span class="slide-num">${idx + 1}</span>
                    </div>
                `;
                slideList.appendChild(div);
            });
        }

        function selectSlide(idx) {
            if (currentIndex >= 0 && slides[currentIndex]) {
                slides[currentIndex].text = scriptText.value;
            }

            currentIndex = idx;
            const slide = slides[idx];
            currentImage.src = slide.image_url;
            scriptText.value = slide.text;

            Array.from(slideList.children).forEach((child, i) => {
                child.className = `slide-item ${i === idx ? 'active' : ''}`;
            });
        }

        scriptText.addEventListener('input', (e) => {
            slides[currentIndex].text = e.target.value;
        });

        // Preview State
        let isPreviewPlaying = false;
        let isPreviewLoading = false;

        async function playPreview() {
            const audio = document.getElementById('audio-player');
            const btn = document.querySelector('button[onclick="playPreview()"]');

            // 1. Handle Stop Action
            if (isPreviewPlaying) {
                audio.pause();
                audio.currentTime = 0;
                isPreviewPlaying = false;
                updatePreviewBtn(btn, 'try');
                return;
            }

            // 2. Prevent multiple clicks during loading
            if (isPreviewLoading) return;

            const text = scriptText.value;
            if (!text.trim()) {
                showError("请先输入文案内容以便试听。");
                return;
            }

            // 3. Start Loading State
            isPreviewLoading = true;
            updatePreviewBtn(btn, 'loading');

            const engine = document.getElementById('engine-select').value;
            const voice = document.getElementById('voice-select').value;

            try {
                const res = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        engine_type: engine,
                        voice_name: voice,
                        rate: getRateParam(),
                        volume: getVolumeParam(),
                        pitch: getPitchParam()
                    })
                });

                if (!res.ok) throw new Error("预览生成失败");

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);

                audio.src = url;

                // Event Listener for Cleanup
                audio.onended = () => {
                    isPreviewPlaying = false;
                    updatePreviewBtn(btn, 'try');
                };

                audio.onerror = () => {
                    isPreviewPlaying = false;
                    updatePreviewBtn(btn, 'try');
                    showError("播放失败");
                };

                await audio.play();

                // 4. Playing State
                isPreviewPlaying = true;
                updatePreviewBtn(btn, 'stop');

            } catch (err) {
                showError(err.message);
                updatePreviewBtn(btn, 'try'); // Reset on error
            } finally {
                isPreviewLoading = false;
                if (!isPreviewPlaying) {
                    // If fetch failed or play failed immediately
                    updatePreviewBtn(btn, 'try');
                }
            }
        }

        function updatePreviewBtn(btn, state) {
            if (state === 'loading') {
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>生成中...</span>`;
                btn.style.opacity = "0.7";
                btn.style.cursor = "not-allowed";
            } else if (state === 'stop') {
                btn.innerHTML = `<i class="fas fa-stop"></i> <span>停止</span>`;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
                btn.classList.add("btn-danger-style"); // Optional: add red color style if you want
            } else {
                // Default 'try'
                btn.innerHTML = `<i class="fas fa-headphones"></i> <span>试听</span>`;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
                btn.classList.remove("btn-danger-style");
            }
        }

        function toggleTaskManager() {
            // In 2.0, this switches to the Tasks sidebar tab
            const taskIcon = document.querySelector('.tab-icon[onclick*="tasks"]');
            switchTab('tasks', taskIcon);
        }

        async function pollTasks() {
            try {
                const res = await fetch('/api/tasks');
                const data = await res.json();
                renderTasksV2(data.tasks);
            } catch (err) {
                console.error("Poll failed", err);
            }
        }

        // Background polling
        setInterval(pollTasks, 3000);

        function renderTasksV2(tasks) {
            const container = document.getElementById('task-list-v2');
            container.innerHTML = '';

            tasks.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">暂无任务</p>';
                return;
            }

            tasks.forEach(task => {
                const item = document.createElement('div');
                item.style.padding = '12px';
                item.style.border = '1px solid #eee';
                item.style.borderRadius = '8px';
                item.style.marginBottom = '10px';
                item.style.background = '#fafafa';

                let statusColor = '#0052cc';
                if (task.status === 'success') statusColor = '#4caf50';
                if (task.status === 'failed') statusColor = '#f44336';

                const progressHtml = task.status === 'processing' ? `
                    <div style="background:#eee; height:4px; border-radius:2px; overflow:hidden; margin:8px 0;">
                        <div style="width:${task.progress}%; background:var(--accent-blue); height:100%; transition:width 0.3s;"></div>
                    </div>
                ` : '';

                const actionHtml = task.status === 'success' ? `
                    <a href="${task.download_url}" target="_blank" style="color:#0052cc; text-decoration:none; font-weight:bold;">下载视频</a>
                ` : '';

                const errorHtml = task.status === 'failed' ? `
                    <div style="color:#f44336; font-size:11px; margin-top:4px;">${task.error || '未知错误'}</div>
                ` : '';

                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="font-weight:500;">任务 ${task.id.substring(0, 6)}</span>
                        <span style="color:${statusColor}; font-size:11px; font-weight:bold;">${task.status.toUpperCase()}</span>
                    </div>
                    <div style="color:#666; font-size:11px; margin-bottom:4px;">${task.message || '排队中...'}</div>
                    ${progressHtml}
                    ${errorHtml}
                    <div style="text-align:right; margin-top:8px;">${actionHtml}</div>
                `;
                container.appendChild(item);
            });
        }

        async function generateVideo() {
            if (!currentJobId) return;
            slides[currentIndex].text = scriptText.value;

            const emptySlides = slides.filter(s => !s.text || !s.text.trim());
            if (emptySlides.length > 0) {
                const indices = emptySlides.map(s => s.index + 1).join(", ");
                showError(`警告: 幻灯片 ${indices} 缺少备注文案。请在生成前补充内容。`);
                return;
            }

            const engine = document.getElementById('engine-select').value;
            const voice = document.getElementById('voice-select').value;
            const enableSubtitles = document.getElementById('subtitle-toggle').checked;
            const subtitleSize = parseInt(document.getElementById('subtitle-size').value, 10);
            const quality = document.getElementById('quality-select').value;

            try {
                const res = await fetch('/api/render', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        slides: slides,
                        engine_type: engine,
                        voice_name: voice,
                        rate: getRateParam(),
                        volume: getVolumeParam(),
                        pitch: getPitchParam(),
                        enable_subtitles: enableSubtitles,
                        subtitle_font_size: subtitleSize,
                        quality: quality
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                toggleTaskManager();
            } catch (err) {
                showError("提交失败: " + err.message);
            }
        }

        function showLoader(msg) {
            loaderText.innerText = msg;
            loader.style.display = 'flex';
        }

        function hideLoader() {
            loader.style.display = 'none';
        }

        const errorModal = document.getElementById('error-modal');
        function showError(msg) {
            document.getElementById('error-text').innerText = msg;
            errorModal.style.display = 'flex';
        }

        function hideError() {
            errorModal.style.display = 'none';
        }

        // --- TTS Parameter Helpers ---
        const rateSlider = document.getElementById('rate-slider');
        const rateVal = document.getElementById('rate-val');
        rateSlider.oninput = () => rateVal.innerText = rateSlider.value + 'x';

        const volSlider = document.getElementById('volume-slider');
        const volVal = document.getElementById('volume-val');
        volSlider.oninput = () => volVal.innerText = volSlider.value + '%';

        const pitchSlider = document.getElementById('pitch-slider');
        const pitchVal = document.getElementById('pitch-val');
        pitchSlider.oninput = () => pitchVal.innerText = (pitchSlider.value > 0 ? '+' : '') + pitchSlider.value + 'Hz';

        function getRateParam() {
            const v = parseFloat(rateSlider.value);
            const percent = Math.round((v - 1.0) * 100);
            return (percent >= 0 ? '+' : '') + percent + '%';
        }

        function getVolumeParam() {
            const percent = parseInt(volSlider.value) - 100;
            return (percent >= 0 ? '+' : '') + percent + '%';
        }

        function getPitchParam() {
            const v = parseInt(pitchSlider.value);
            return (v >= 0 ? '+' : '') + v + 'Hz';
        }

        function insertPause() {
            const start = scriptText.selectionStart;
            const end = scriptText.selectionEnd;
            const text = scriptText.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);
            scriptText.value = before + '[停顿]' + after;
            scriptText.selectionStart = scriptText.selectionEnd = start + 4;
            scriptText.focus();
            // Trigger input event to save state
            scriptText.dispatchEvent(new Event('input'));
        }
    </script>


    <script>
        // Init logic
        loadConfig();

        // Engine Voice Map
        const engineVoices = {
            edge: [
                {
                    label: "普通话 (大陆)",
                    options: [
                        { val: "zh-CN-XiaoxiaoNeural", text: "晓晓 (女声, 温暖)" },
                        { val: "zh-CN-YunxiNeural", text: "云希 (男声, 沉稳)" },
                        { val: "zh-CN-YunjianNeural", text: "云健 (男声, 体育)" },
                        { val: "zh-CN-XiaoyiNeural", text: "晓伊 (女声, 可爱)" },
                        { val: "zh-CN-YunyangNeural", text: "云扬 (男声, 新闻)" },
                        { val: "zh-CN-Liaoning-XiaobeiNeural", text: "晓北 (东北话, 女)" }
                    ]
                },
                {
                    label: "普通话 (台湾)",
                    options: [
                        { val: "zh-TW-HsiaoChenNeural", text: "晓臻 (女声)" },
                        { val: "zh-TW-YunJheNeural", text: "云哲 (男声)" },
                        { val: "zh-TW-HsiaoYuNeural", text: "晓雨 (女声)" }
                    ]
                },
                {
                    label: "粤语 (香港)",
                    options: [
                        { val: "zh-HK-HiuMaanNeural", text: "晓曼 (女声)" },
                        { val: "zh-HK-WanLungNeural", text: "云龙 (男声)" },
                        { val: "zh-HK-HiuGaaiNeural", text: "晓佳 (女声)" }
                    ]
                }
            ],
            system: [
                {
                    label: "macOS 本地",
                    options: [
                        { val: "Tingting", text: "婷婷 (普通话)" },
                        { val: "Meijia", text: "美佳 (台湾)" },
                        { val: "Sinji", text: "善怡 (粤语)" }
                    ]
                }
            ],
            xunfei: [
                {
                    label: "讯飞特色",
                    options: [
                        { val: "xiaoyan", text: "小燕 (女声, 青年)" },
                        { val: "aisjiuxu", text: "许久 (男声, 青年)" },
                        { val: "aisxping", text: "小萍 (女声, 青年)" },
                        { val: "aisjinger", text: "小婧 (女声, 魅力)" },
                        { val: "aisbabyxu", text: "许小宝 (童声)" }
                    ]
                }
            ],
            openai: [
                {
                    label: "OpenAI HD",
                    options: [
                        { val: "alloy", text: "Alloy (通用)" },
                        { val: "echo", text: "Echo (柔和)" },
                        { val: "fable", text: "Fable (叙事)" },
                        { val: "onyx", text: "Onyx (深沉)" },
                        { val: "nova", text: "Nova (活力)" },
                        { val: "shimmer", text: "Shimmer (清晰)" }
                    ]
                },
            ],
            google: [
                {
                    label: "Google Cloud",
                    options: [
                        { val: "cmn-CN-Wavenet-A", text: "女声 A (Wavenet)" },
                        { val: "cmn-CN-Wavenet-B", text: "男声 B (Wavenet)" },
                        { val: "cmn-CN-Wavenet-C", text: "男声 C (Wavenet)" },
                        { val: "cmn-CN-Wavenet-D", text: "女声 D (Wavenet)" }
                    ]
                }
            ],
            volcengine: [
                {
                    label: "火山引擎",
                    options: [
                        { val: "BV700_streaming", text: "灿灿 (通用)" },
                        { val: "BV701_streaming", text: "林林 (通用)" }
                    ]
                }
            ],
            fishspeech: [
                {
                    label: "Fish Audio (云端/克隆)",
                    options: [
                        { val: "7f02fd683e0d4050a133900c4644377b", text: "精致女声 (示例)" },
                        { val: "84a0c102ad774683a1c11bb8c88bf6fc", text: "精致男声 (示例)" },
                        { val: "custom", text: "自定义 (见备注)" }
                    ]
                }
            ]
        };

        const engineSelect = document.getElementById('engine-select');
        const voiceSelect = document.getElementById('voice-select');

        engineSelect.addEventListener('change', () => {
            updateVoiceList();
        });

        function updateVoiceList() {
            const engine = engineSelect.value;
            const groups = engineVoices[engine] || [];

            // Save current selection if possible? No, usually reset is better on engine change.
            voiceSelect.innerHTML = '';

            groups.forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.label;
                group.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.val;
                    option.innerText = opt.text;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            });
        }

        // Initialize voice list
        updateVoiceList();

        function loadConfig() {
            fetch('/api/config')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('xunfei-appid').value = data.xunfei_app_id || '';
                    document.getElementById('xunfei-api-key').value = data.xunfei_api_key || '';
                    document.getElementById('xunfei-api-secret').value = data.xunfei_api_secret || '';

                    document.getElementById('volc-access-key').value = data.volc_access_key || '';
                    document.getElementById('volc-secret-key').value = data.volc_secret_key || '';
                    document.getElementById('volc-app-key').value = data.volc_app_key || '';

                    document.getElementById('google-key').value = data.google_api_key || '';

                    document.getElementById('openai-key').value = data.openai_api_key || '';
                    document.getElementById('openai-base-url').value = data.openai_base_url || '';

                    document.getElementById('fish-key').value = data.fish_speech_api_key || '';
                    document.getElementById('fish-url').value = data.fish_speech_api_url || '';
                });
        }

        function saveConfig() {
            const data = {
                xunfei_app_id: document.getElementById('xunfei-appid').value,
                xunfei_api_key: document.getElementById('xunfei-api-key').value,
                xunfei_api_secret: document.getElementById('xunfei-api-secret').value,

                volc_access_key: document.getElementById('volc-access-key').value,
                volc_secret_key: document.getElementById('volc-secret-key').value,
                volc_app_key: document.getElementById('volc-app-key').value,

                google_api_key: document.getElementById('google-key').value,

                openai_api_key: document.getElementById('openai-key').value,
                openai_base_url: document.getElementById('openai-base-url').value,

                fish_speech_api_key: document.getElementById('fish-key').value,
                fish_speech_api_url: document.getElementById('fish-url').value
            };

            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => {
                if (r.ok) {
                    const msg = document.getElementById('save-msg');
                    msg.style.display = 'block';
                    setTimeout(() => msg.style.display = 'none', 3000);
                } else {
                    alert('保存失败');
                }
            });
        }
    </script>
</body>

</html>